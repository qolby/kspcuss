---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { sanityClient } from '../../lib/sanity';
import { ALL_POST_SLUGS_QUERY, POST_BY_SLUG_QUERY } from '../../lib/queries';
import type { SanityPost } from '../../types/sanity';
import { PortableText } from '@portabletext/react';
import { urlFor } from '../../lib/image';

export async function getStaticPaths() {
  const slugs: { slug: string }[] =
    await sanityClient.fetch(ALL_POST_SLUGS_QUERY);

  return slugs.map((item) => ({
    params: { slug: item.slug },
  }));
}

const { slug } = Astro.params;
const post: SanityPost | null = await sanityClient.fetch(POST_BY_SLUG_QUERY, {
  slug,
});

if (!post) {
  return Astro.redirect('/404');
}

function formatDate(dateString: string) {
  return new Date(dateString).toLocaleDateString('id-ID', {
    day: 'numeric',
    month: 'long',
    year: 'numeric',
  });
}
---

<BaseLayout title={post.title}>
  <article class="py-16 md:py-24">
    <div class="max-w-180 mx-auto px-5 md:px-8">
      <!-- Back link -->

      <a
        href="/berita"
        class="inline-flex items-center gap-1.5 text-sm
      text-neutral-400 hover:text-primary transition-colors duration-200 mb-10"
      >
        ‚Üê Kembali ke Berita
      </a>

      <!-- Post header -->
      <header class="mb-8">
        <div class="flex items-center gap-3 mb-4">
          <span
            class={`text-xs font-medium px-2.5 py-1 rounded-full ${
              post.category === 'pengumuman'
                ? 'bg-amber-50 text-amber-700'
                : 'bg-primary/10 text-primary'
            }`}
          >
            {post.category === 'pengumuman' ? 'Pengumuman' : 'Berita'}
          </span>
          <span class="text-xs text-neutral-400">
            {formatDate(post.publishedAt)}
          </span>
        </div>

        <h1
          class="text-2xl md:text-3xl font-semibold text-neutral-900 leading-snug"
        >
          {post.title}
        </h1>

        {
          post.excerpt && (
            <p class="mt-4 text-neutral-500 text-lg leading-relaxed">
              {post.excerpt}
            </p>
          )
        }
      </header>

      <!-- Featured image -->
      {
        post.image && (
          <div class="mb-10 rounded-xl overflow-hidden">
            <img
              src={urlFor(post.image)
                .width(720)
                .height(405)
                .auto('format')
                .url()}
              alt={post.image.alt ?? post.title}
              class="w-full object-cover"
            />
          </div>
        )
      }

      <!-- Divider (only shown when there's no image) -->
      {!post.image && <hr class="border-neutral-200 mb-10" />}

      <!-- Article body -->
      {
        post.body && (
          <div class="prose prose-neutral max-w-none">
            <PortableText value={post.body} />
          </div>
        )
      }
    </div>
  </article>
</BaseLayout>
